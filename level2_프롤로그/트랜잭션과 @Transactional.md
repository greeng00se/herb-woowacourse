## 트랜잭션

데이터베이스에서 논리적 기능을 수행하기 위한 작업의 단위를 말한다.

트랜잭션은 작업의 완전성과 데이터의 정합성을 보장해 준다.

논리적인 작업 셋을 완벽하게 처리하거나, 오류 시 작업의 일부만 적용되는 현상을 막아준다.

### 트랜잭션 속성

원자성(Atomicity): 트랜잭션 내에서 실행된 작업들은 모두 성공하거나, 실패해야 한다.

일관성(Consistency): 트랜잭션이 수행되기 전과 후에 데이터베이스가 일관된 상태를 유지해야 한다.

격리성(Isolation): 각각의 트랜잭션은 독립적이라 서로에게 영향을 주지 않아야 한다.

지속성(Durability): 트랜잭션이 성공적으로 완료된다면 영구적으로 결과에 반영되어야 한다.

### 트랜잭션 주의사항

트랜잭션은 꼭 필요한 최소의 코드에만 적용하는 것이 좋다.(트랜잭션의 범위를 최소화하라)
구현해야 하는 업무에 따라 트랜잭션을 묶거나 트랜잭션에서 제외하고, 네트워크 작업이 있는 경우 반드시 트랜잭션에서 배제해야 한다.

### 왜 네트워크 작업이 있을 때 트랜잭션에서 배제해야 할까? 🤔

데이터의 일관성과 안전성을 보장하기 위해 배제해야 한다.

네트워크 작업을 트랜잭션 내부에 포함한다면 다음과 같은 문제가 발생할 수 있다.

- 네트워크 작업이 중간에 실패할 가능성(안전성 X)
- 통신으로 인해 데이터가 변경될 수 있는 부분(일관성 X)

### @Transactional

스프링에서 @Transactional 애너테이션을 이용해 트랜잭션 처리를 할 수 있다.

해당 애너테이션을 사용한다면 기본적으로 프록시 방식의 AOP가 적용된다.

`@Transactional` 애노테이션이 특정 클래스나 메서드에 하나라도 있으면 트랜잭션 AOP는 프록시를 만들어서 스프링 컨테이너에 등록한다.

- 실제 객체 대신 프록시가 스프링 컨테이너에 등록된다.

프록시는 클래스 대상으로 만들어진다.

- 트랜잭션을 사용 안하는 로직인 경우 프록시 클래스가 실제 클래스로 위임하기만 한다.

### @Transactional(readOnly = true)

setReadOnly(true) 설정이 된 Connection으로 연결을 시도를 한다.

이 설정을 하는 경우 DB마다 다르게 동작한다.

- h2의 Connection 구현체는 readOnly 설정을 무시하는 방향으로 구현되었기 때문에 Transactional(readOnly = true)가 적용되지 않는다.
- mysql의 기본 스토리지 엔진인 InnoDB의 경우 읽기 전용으로 알려진 트랜잭션의 경우 트랜잭션 ID를 설정하지 않기 때문에 조회 속도가 더 빨라질 수 있다.

추가로 현업에서는 고가용성 내결함성 등을 위하여 클러스터를 구성하여 사용하는 경우가 많고, 이 경우 readOnly 설정이 되어있다면 읽기 전용 DB로 질의가 들어가서 부하 분산의 효과가 있다고 한다.

### 참고 자료

Real MySQL 8.0 - 백은빈, 이성욱

스프링 DB 2편 - 데이터 접근 활용 기술 -  김영한

https://dev.mysql.com/doc/refman/8.0/en/innodb-performance-ro-txn.html    